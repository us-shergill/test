import io
from datetime import datetime
import pandas as pd
import smbclient

# --- Your NAS details ---
NAS_HOST = "mdnas1.healthspring.inside"   # server/hostname only (no slashes)
USERNAME = "MYDOMAIN\\svc_vendor"         # or just "svc_vendor" if no domain
PASSWORD = dbutils.secrets.get("kv", "smb-pass")  # or put a literal for quick test

UNC_DIR = r"\\mdnas1.healthspring.inside\IS\ApplicationData\EXPORT\CardFile\SARS & NR\NextYear_Production_Files\MailDateResponseFiles"

# 1) Authenticate once per session
smbclient.register_session(NAS_HOST, username=USERNAME, password=PASSWORD)

# 2) Make sure the directory exists (will no-op if it already does)
smbclient.makedirs(UNC_DIR, exist_ok=True)

# 3) Create a tiny XLSX in memory
df = pd.DataFrame({
    "Message": ["Hello NAS via smbclient"],
    "When": [datetime.now().strftime("%Y-%m-%d %H:%M:%S")]
})
buf = io.BytesIO()
with pd.ExcelWriter(buf, engine="xlsxwriter") as xw:
    df.to_excel(xw, index=False, sheet_name="Test")

# 4) Write it to your NAS path
fname = f"smoketest_{datetime.now().strftime('%Y%m%d_%H%M%S')}.xlsx"
target = UNC_DIR.rstrip("\\") + "\\" + fname
with smbclient.open_file(target, mode="wb") as fh:
    fh.write(buf.getvalue())

print("Wrote:", target)

# 5) List the directory to verify
print("\nDirectory listing:")
for name in smbclient.listdir(UNC_DIR):
    print(" -", name)
